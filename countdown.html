<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多組計時器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-direction: column;
            gap: 20px; 
            min-height: 100vh;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding-top: 75px; /* 增加頂部內距，避免內容被固定區塊遮擋 */
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background-color: #2c2c2c;
            color: #f4f4f4;
        }
        
        body.dark-mode .date-display,
        body.dark-mode .timer-container {
            background-color: #444;
            color: #f4f4f4;
            border-bottom: 1px solid #555;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        body.dark-mode .group-container {
            background: #3a3a3a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .controls-container {
            width: 100%;
            text-align: center;
            margin-top: 25px;
        }
        
        .controls-container label, .controls-container select {
            font-size: 1.1em;
        }

        .date-display {
            position: fixed; /* 固定在視窗上 */
            top: 0; /* 距離頂部0 */
            left: 0; /* 距離左側0 */
            width: 100%; /* 佔據整個寬度 */
            z-index: 1000; /* 確保它在最上層 */
            background-color: #fff;
            color: #333;
            font-size: 1.2em;
            padding: 15px 0;
            text-align: center;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode .date-display {
            background-color: #444;
            color: #f4f4f4;
            border-bottom: 1px solid #555;
        }
        
        .main-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 50px; 
            width: 100%;
        }
        .group-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            flex: 0 0 calc(20% - 40px);
            box-sizing: border-box; 
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .group-controls {
            margin-top: 10px;
            width: 100%;
        }
        .group-controls button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: #fff;
            background-color: #007BFF;
            transition: background-color 0.2s;
            width: 100%;
        }
        .group-controls button:hover {
            background-color: #0056b3;
        }
        .timers-group {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%; 
        }
        .timer-container {
            text-align: center;
            background: #fff;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .timer {
            font-size: 2.5em;
            font-weight: bold;
            color: #007BFF; /* 預設藍色 */
            margin-bottom: 10px;
        }
        .timer.running {
            color: #28a745; /* 倒數中綠色 */
        }
        .controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .controls button {
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: #fff;
            flex: 1;
            transition: background-color 0.2s;
        }
        .start-btn {
            background-color: #28a745;
        }
        .start-btn:hover {
            background-color: #218838;
        }
        .reset-btn {
            background-color: #6c757d;
            display: none;
        }
        .reset-btn:hover {
            background-color: #5a6268;
        }
        .finished {
            color: #dc3545; /* 倒數結束紅色 */
        }
        #darkModeToggle {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: #fff;
            background-color: #555;
            transition: background-color 0.2s;
        }
        #darkModeToggle:hover {
            background-color: #333;
        }
    </style>
</head>
<body class="dark-mode">

    <div id="dateResult" class="date-display"></div>

    <div class="controls-container">
        <button id="darkModeToggle" onclick="toggleDarkMode()">切換背景</button>
        <label for="groupCount">群組數:</label>
        <select id="groupCount" onchange="generateUnits(this.value)">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
        </select>
    </div>

    <div id="mainContainer" class="main-container"></div>
    
    <audio id="alarmSound">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <script>
        const timerIntervals = {};
        const alarmSound = document.getElementById('alarmSound');
        let soundTimeoutId = null;

        const timerPresets = [
            { minutes: 2, seconds: 25 },
            { minutes: 1, seconds: 18 },
            { minutes: 2, seconds: 35 }
        ];

        function displayTime(elementId, minutes, seconds) {
            const timerElement = document.getElementById(elementId);
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(seconds).padStart(2, '0');
            timerElement.textContent = `${formattedMinutes}:${formattedSeconds}`;
            timerElement.classList.remove('finished');
        }

        function playAlarm() {
            if (soundTimeoutId) {
                clearTimeout(soundTimeoutId);
            }
            
            alarmSound.play().catch(e => console.log('音訊播放失敗:', e));
            
            soundTimeoutId = setTimeout(() => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }, 3000);
        }

        function startTimer(elementId) {
            const timerElement = document.getElementById(elementId);
            const initialMinutes = parseInt(timerElement.dataset.initialMinutes, 10);
            const initialSeconds = parseInt(timerElement.dataset.initialSeconds, 10);

            clearInterval(timerIntervals[elementId]);
            let totalSeconds = initialMinutes * 60 + initialSeconds;

            timerElement.classList.add('running');
            timerElement.classList.remove('finished');

            // 隱藏開始按鈕，顯示重設按鈕
            const container = timerElement.closest('.timer-container');
            container.querySelector('.start-btn').style.display = 'none';
            container.querySelector('.reset-btn').style.display = 'block';

            function updateTimer() {
                if (totalSeconds < 0) {
                    clearInterval(timerIntervals[elementId]);
                    timerElement.textContent = "00:00";
                    timerElement.classList.remove('running');
                    timerElement.classList.add('finished');
                    playAlarm();
                    return;
                }
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                displayTime(elementId, minutes, seconds);
                totalSeconds--;
            }
            updateTimer();
            timerIntervals[elementId] = setInterval(updateTimer, 1000);
        }

        function resetTimer(elementId) {
            const timerElement = document.getElementById(elementId);
            const initialMinutes = parseInt(timerElement.dataset.initialMinutes, 10);
            const initialSeconds = parseInt(timerElement.dataset.initialSeconds, 10);

            clearInterval(timerIntervals[elementId]);
            displayTime(elementId, initialMinutes, initialSeconds);
            timerElement.classList.remove('running', 'finished');
            if (soundTimeoutId) {
                clearTimeout(soundTimeoutId);
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }

            // 顯示開始按鈕，隱藏重設按鈕
            const container = timerElement.closest('.timer-container');
            container.querySelector('.start-btn').style.display = 'block';
            container.querySelector('.reset-btn').style.display = 'none';
        }

        function resetGroupTimers(groupIndex) {
            const groupContainer = document.getElementById(`group_${groupIndex}`);
            if (groupContainer) {
                const timerElements = groupContainer.querySelectorAll('.timer');
                timerElements.forEach(timer => {
                    resetTimer(timer.id);
                });
            }
        }
        
        function generateUnits(count) {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const groupHtml = `
                    <div class="group-container" id="group_${i}">
                        <div class="group-controls">
                            <button onclick="resetGroupTimers(${i})">群組 ${i} 全部重設</button>
                        </div>
                        <div class="timers-group">
                            ${timerPresets.map((preset, index) => {
                                const timerId = `timer_${i}_${index + 1}`;
                                return `
                                    <div class="timer-container">
                                        <div id="${timerId}" class="timer" 
                                            data-initial-minutes="${preset.minutes}" 
                                            data-initial-seconds="${preset.seconds}">
                                        </div>
                                        <div class="controls">
                                            <button class="start-btn" onclick="startTimer('${timerId}')">開始</button>
                                            <button class="reset-btn" onclick="resetTimer('${timerId}')">重設</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                mainContainer.insertAdjacentHTML('beforeend', groupHtml);
            }
            document.querySelectorAll('.group-container').forEach((group, index) => {
                resetGroupTimers(index + 1);
            });
        }
        
        function updateDateResult() {
            const now = new Date();
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const taiwanTime = new Date(utcTime + (8 * 3600000));
            const month = taiwanTime.getMonth() + 1;
            const day = taiwanTime.getDate();
            const result = (month + day) * 5;
            const binaryResult = (result >>> 0).toString(2).padStart(8, '0');

            const onePositions = [];
            for (let i = 0; i < binaryResult.length; i++) {
                if (binaryResult[i] === '1') {
                    onePositions.push(i + 1);
                }
            }
            
            const formattedBinary = binaryResult.substring(0, 4) + '&nbsp;&nbsp;&nbsp;' + binaryResult.substring(4, 8);

            const dateResultElement = document.getElementById('dateResult');
            dateResultElement.innerHTML = `
                二進位: <strong>${formattedBinary}</strong><br>
                位數: <strong>${onePositions.join('')}</strong>
            `;
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateDateResult();
            generateUnits(2); // 預設生成2個群組
        });
    </script>

</body>
</html>
